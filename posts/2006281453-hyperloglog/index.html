<!doctype html><html dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="content-language" content="en-us"><meta name="viewport" content="width=device-width,initial-scale=1"><title>HyperLogLog &#183; Youngjoon Lee</title><meta name="title" content="HyperLogLog &#183; Youngjoon Lee"><meta name="description" content="Cardinality"><link rel="canonical" href="https://oudwud.dev/posts/2006281453-hyperloglog/"><link type="text/css" rel="stylesheet" href="/css/main.min.3db6f820f85fa8b01cb73aa7c8e2c207d0837c77e04635cc5b4dd9a5b2327ac8.css" integrity="sha256-Pbb4IPhfqLActzqnyOLCB9CDfHfgRjXMW03ZpbIyesg="><link rel="icon" sizes="192x192" href="/logo-192.png"><link rel="apple-touch-icon" href="/logo-192.png"><link rel="mask-icon" href="/logo.svg" color="blue"><link rel="manifest" href="/site.webmanifest"><meta property="og:title" content="HyperLogLog"><meta property="og:description" content="Cardinality"><meta property="og:type" content="article"><meta property="og:url" content="https://oudwud.dev/posts/2006281453-hyperloglog/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-06-28T14:53:42+09:00"><meta property="article:modified_time" content="2020-06-28T14:53:42+09:00"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="HyperLogLog"><meta name="twitter:description" content="Cardinality"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","articleSection":"Posts","name":"HyperLogLog","headline":"HyperLogLog","description":"Cardinality","inLanguage":"en-us","author":{"@type":"Person","name":""},"creator":{"@type":"Person","name":""},"copyrightHolder":"","copyrightYear":"2020","dateCreated":"2020-06-28T14:53:42\u002b09:00","datePublished":"2020-06-28T14:53:42\u002b09:00","dateModified":"2020-06-28T14:53:42\u002b09:00","url":"https:\/\/oudwud.dev\/posts\/2006281453-hyperloglog\/","wordCount":"715","keywords":[]}</script><meta name="generator" content="Hugo 0.111.3"><script defer src="/js/main.min.3bfc9774c933123803ba09c8b89eeda9822dd63321db002f0bfd9cdc3129b0fa.js" integrity="sha256-O/yXdMkzEjgDugnIuJ7tqYIt1jMh2wAvC/2c3DEpsPo="></script>
<script>"theme"in localStorage||(localStorage.theme="light"),(localStorage.theme==="dark"||(!("theme"in localStorage)||localStorage.theme==="auto")&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.documentElement.classList.add("dark")</script></head><body class="w-full min-h-full" x-data="{ up: false }"><div x-data="{ open: false }" @keydown.window.escape="open = false" class="sticky inset-x-0 top-0 z-10"><div class="fixed z-10 flex w-48 h-screen lg:hidden" :class="open ? '' : 'hidden'" x-ref="dialog" aria-modal="true"><div class="fixed inset-0 bg-black bg-opacity-25" :class="open ? '' : 'hidden'" x-transition:enter="transition-opacity ease-linear duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="transition-opacity ease-linear duration-300" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" x-description="Off-canvas menu overlay, show/hide based on off-canvas menu state." @click="open = false" aria-hidden="true"></div><div class="fixed inset-0 flex flex-col w-full h-full pb-12 overflow-y-auto shadow-xl bg-neutral-50 text-neutral-900 dark:bg-neutral-800 dark:text-neutral-200 max-w-xxs" :class="open ? '' : 'hidden'" x-transition:enter="transition ease-in-out duration-300" x-transition:enter-start="-translate-x-full" x-transition:enter-end="translate-x-0" x-transition:leave="transition ease-in-out duration-300" x-transition:leave-start="translate-x-0" x-transition:leave-end="-translate-x-full" x-description="Off-canvas menu, show/hide based on off-canvas menu state."><div class="flex px-4 pt-5 pb-2"><button type="button" title="Close menu" class="inline-flex items-center justify-center p-2 -m-2 rounded-md text-neutral-400" @click="open = false">
<span class="sr-only">Close menu</span><svg class="w-6 h-6" x-description="Heroicon name: outline/x" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentcolor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18 18 6M6 6l12 12"/></svg></button></div><ul class="py-4 divide-y divide-neutral-200"><li class="flow-root px-4 py-2"><a href="/" title="Youngjoon Lee" class="block p-2 -m-2 font-medium">Home</a></li><li class="flow-root px-4 py-2
bg-neutral-200 dark:bg-neutral-900"><a href="/posts/" title="Posts" class="block p-2 -m-2 font-medium">Blog</a></li><li class="flow-root px-4 py-2"><a href="/categories/" title="Categories" class="block p-2 -m-2 font-medium">Categories</a></li><li class="flow-root px-4 py-2"><a href="/tags/" title="Tags" class="block p-2 -m-2 font-medium">Tags</a></li></ul></div></div><header class="shadow dark:shadow-dark bg-neutral-50 text-neutral-900 dark:bg-neutral-800 dark:text-neutral-200"><nav class="container flex leading-12 items-center px-6 mx-auto max-w-7xl lg:px-8 xl:px-12 bg-neutral-50 text-neutral-900 dark:bg-neutral-800 dark:text-neutral-200" aria-label="Top"><a class="relative hidden p-2 align-middle lg:block" rel="me" href="/" title="Youngjoon Lee"><img src="/logo-192.png" class="h-8 w-auto" alt="Youngjoon Lee"></a>
<button class="lg:hidden" type="button" @click="open = true" aria-label="Open menu"><svg class="block w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentcolor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg></button><div class="flex-grow h-12 mx-2"><div class="relative w-full h-full"><div class="absolute max-w-full" :class="up ? 'hidden' : ''" x-transition.duration.500ms><span class="font-semibold overflow-hidden text-ellipsis whitespace-nowrap">Youngjoon Lee</span></div><template x-if="true"><div class="absolute top-0 left-0 right-0 max-w-full" :class="up ? '' : 'hidden'" x-transition.duration.500ms><span class="overflow-hidden text-ellipsis whitespace-nowrap">HyperLogLog</span></div></template></div></div><ul class="shrink hidden ml-7 lg:flex flex-row justify-end list-none"><li class="border-b-2 border-transparent text-right mr-7 hover:border-primary-500"><a href="/" title="Youngjoon Lee">Home</a></li><li class="border-b-2 border-transparent text-right mr-7 hover:border-primary-500
border-primary-500"><a href="/posts/" title="Posts">Blog</a></li><li class="border-b-2 border-transparent text-right mr-7 hover:border-primary-500"><a href="/categories/" title="Categories">Categories</a></li><li class="border-b-2 border-transparent text-right mr-7 hover:border-primary-500"><a href="/tags/" title="Tags">Tags</a></li></ul><button id="switchTheme" class="w-8 h-8 flex justify-center items-center focus:outline-none">
<span class="sr-only">Switch theme</span><svg class="w-5 h-5" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/></svg>
<span class="light"></span><span class="dark"></span></button>
<script>document.getElementById("switchTheme").addEventListener("click",function(){localStorage.theme==="dark"||(!("theme"in localStorage)||localStorage.theme==="auto")&&window.matchMedia("(prefers-color-scheme: dark)").matches?(document.documentElement.classList.remove("dark"),localStorage.theme="light"):(localStorage.theme==="light"||(!("theme"in localStorage)||localStorage.theme==="auto")&&window.matchMedia("(prefers-color-scheme: light)").matches)&&(document.documentElement.classList.add("dark"),localStorage.theme="dark")})</script></nav></header></div><main class="container flex flex-row px-6 mx-auto my-6 lg:px-8 xl:px-12 max-w-7xl"><article class="flex-grow mx-auto text-lg lg:text-xl min-w-0 max-w-prose"><header class="text-base"><h1 class="my-3 text-3xl font-semibold text-neutral-800 dark:text-neutral-200" x-intersect:enter="up = false" x-intersect:leave="up = true">HyperLogLog</h1><div class="mb-6 text-base text-neutral-500 dark:text-neutral-400"><div class="flex flex-row items-center"><time datetime="2020-06-28 14:53:42 +0900 +0900">28 June 2020</time><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">4 mins</span></div></div></header><section class="max-w-none text-base prose dark:prose-invert"><p>Given a stream of strings, let&rsquo;s think how to count the number of distinct strings (Cardinality).</p><h2 id="using-in-memory-data-structure">Using in-memory data structure <a class="heading-anchor" href="#using-in-memory-data-structure" aria-hidden="true">#</a></h2><p>The simplest way might be using a in-memory data structure, such as HashSet. Whenever we read a string from the stream, we can add it to the HashSet. Finally, we can return the final size of HashSet.</p><p>But, this way needs <code>O(n)</code> of memory at most, if <code>n</code> is the number of strings in the stream. We need a smarter way. It might be so hard to implement a fast algorithm which count the exact number of distinct strings. Let&rsquo;s think about the probabilistic counting.</p><h2 id="probabilistic-counting">Probabilistic counting <a class="heading-anchor" href="#probabilistic-counting" aria-hidden="true">#</a></h2><p>Let&rsquo;s use a hash function. Then, we can convert strings into randomly distributed numbers in a certain range. And, let&rsquo;s take a look at the least significant <code>k</code> bits in the numbers (hash values). The figure below illustrates an example of the probability of observing a sequence of three consecutive <code>0</code>s (<code>k = 3</code>).</p><pre tabindex="0"><code>            ....... 0 0 0 ---&gt; prob = 1/(2^3) = 1/8
            ....... 0 0 1
            ....... 0 1 0
 hash(x) -&gt; ....... 0 1 1
            ....... 1 0 0
            ....... 1 0 1
            ....... 1 1 0
            ....... 1 1 1
</code></pre><p><strong>In other words, on average, a sequence of <code>k</code> consecutive <code>0</code>s will occur once in every <code>2^k</code> distinct entries.</strong> To estimate the number of distinct elements using this pattern, all we need to do is just record the length of the longest sequence of consecutive <code>0</code>s. Mathematically, if we denote <code>p(x)</code> as the number of consecutive <code>0</code>s in <code>hash(x)</code>, the cardinality of the set <code>{x1, x2, ..., xm}</code> is <code>2^R</code>, where <code>R = max(p(x1), p(x2), ..., p(xm))</code></p><p>But, there are two disadvantages:</p><ol><li>The estimate is too sparse. The <code>2^R</code> can only be one of <code>{1, 2, 4, 8, 16, ..., 1024, 2048, ...}</code>.</li><li>The estimator has high variability. Because it&rsquo;s recoding the maximum <code>p(x)</code>, it requires only one entry whose hash value has too many consecutive <code>0</code>s to produce a drastically inaccurate (overestimated) estimate of cardinality.</li></ol><p>On the plus side, the estimator has a very small memory footprint. We only need a memory space to record the maximum number of consecutive <code>0</code>s.</p><h2 id="improving-accuracy-loglog">Improving accuracy: LogLog <a class="heading-anchor" href="#improving-accuracy-loglog" aria-hidden="true">#</a></h2><p>We can use many estimators instead of one, and average the results, in order to improve accuracy. It means we can use <code>m</code> independent hash functions: <code>{h1(x), h2(x), ..., hm(x)}</code>. Then, <code>2^R = 2 ^ (1/m * (R1+...+Rm))</code>, where the corresponding maximum number of consecutive <code>0</code>s for each one: <code>R1, ..., Rm</code>.</p><p>However, this requires a lot of computations for <code>m</code> hash values for each input string. The workaround proposed by <a href="http://www.ic.unicamp.br/~celio/peer2peer/math/bitmap-algorithms/durand03loglog.pdf" target="_blank" rel="noopener">Durand and Flajolet</a> is to use a single hash function, but use part of its output to split values into one of many buckets.</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">h</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">bucket_no</span> <span class="o">=</span> <span class="n">k_msb</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>   <span class="c1"># Most Significant k-Bits</span>
</span></span><span class="line"><span class="cl"><span class="n">num_zeros</span> <span class="o">=</span> <span class="n">count_zeros_from_right</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">bucket</span><span class="p">[</span><span class="n">bucket_no</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bucket</span><span class="p">[</span><span class="n">bucket_no</span><span class="p">],</span> <span class="n">num_zeros</span><span class="p">)</span>
</span></span></code></pre></div><p>By having <code>m</code> buckets, we are bascially simulating a situation in which we had <code>m</code> different hash functions. Finally, the formula below is used to get an estimate on the count of distinct values using the <code>m</code> bucket values: <code>{R1, R2, ..., Rm}</code>.</p><pre tabindex="0"><code>CARDINALITY = constant * m * 2 ^ (1/m * (R1+...+Rm))
</code></pre><p>Durand-Flajolet derived the <code>constant = 0.79402</code>. For <code>m</code> buckets, this reduces the standard error to about <code>1.3 * sqrt(m)</code>. Thus, with 2048 buckets where each bucket is 5 bits (which can record a maximum of 32 consecutive <code>0</code>s), we can expect an average error of about 2.8%; 5 bits per bucket is enough to estimate cardinalities up to <code>2 ^ 27</code> per the original paper and required only <code>2048 * 5 = 1.2 KB</code> of memory.</p><h2 id="improving-accuracy-even-further-hyperloglog">Improving accuracy even further: HyperLogLog <a class="heading-anchor" href="#improving-accuracy-even-further-hyperloglog" aria-hidden="true">#</a></h2><ol><li>Durand-Flajolet observed that outliers greatly decreases the accuracy. Thus, we can throw out the largest values before averaging. Specifically, when collecting the bucket values, accuracy can be improved from <code>1.3 * sqrt(m)</code> to only <code>1.05 * sqrt(m)</code> by only retaining the 70% smallest values and discarding the rest for averaging (aka. <code>SuperLogLog</code>).</li><li>For HyperLogLog, use the harmonic mean instead of the geometric mean, which edging down the error to slightly less than <code>1.04 * sqrt(m)</code> with no increase in required storages.</li></ol><pre tabindex="0"><code>CARDINALITY = constant * m * m / (2^(-R1) + ... + 2^(-Rm))
</code></pre><h2 id="references">References <a class="heading-anchor" href="#references" aria-hidden="true">#</a></h2><p><a href="https://engineering.fb.com/data-infrastructure/hyperloglog" target="_blank" rel="noopener">https://engineering.fb.com/data-infrastructure/hyperloglog/</a></p></section><footer class="pt-8"><div class="flex text-base text-neutral-500 dark:text-neutral-400"><div class="place-self-center"></div></div><div class="article-pagination"><hr><div><span><a class="flex text-right" href="/posts/2006111140-argo-release/"><span class="mr-3 article-pagination-direction">&larr;</span>
<span class="flex flex-col"><span class="article-pagination-title">My first open source contribution was just released.</span>
<span class="article-pagination-date"><time datetime="2020-06-11 11:40:26 +0900 +0900">11 June 2020</time></span></span></a></span>
<span><a class="flex" href="/posts/2007061657-thought_about_storage_on_k8s/"><span class="flex flex-col"><span class="article-pagination-title">Thought about Storage on Kubernetes</span>
<span class="article-pagination-date"><time datetime="2020-07-06 16:57:28 +0900 +0900">6 July 2020</time></span></span>
<span class="ml-3 article-pagination-direction">&rarr;</span></a></span></div></div></footer></article><aside class="flex-auto min-w-0 space-y-6 pl-10 mt-3 pr-4 xl:pl-16 hidden lg:block text-sm xl:text-base"><div class="sticky self-start top-20 min-h-screen overflow-y-auto truncate"><label class="font-bold text-lg mb-4">Table of contents</label><nav id="TableOfContents"><ul><li><a href="#using-in-memory-data-structure">Using in-memory data structure</a></li><li><a href="#probabilistic-counting">Probabilistic counting</a></li><li><a href="#improving-accuracy-loglog">Improving accuracy: LogLog</a></li><li><a href="#improving-accuracy-even-further-hyperloglog">Improving accuracy even further: HyperLogLog</a></li><li><a href="#references">References</a></li></ul></nav></div></aside><script>window.addEventListener("DOMContentLoaded",()=>{const t=new IntersectionObserver(e=>{e.forEach(e=>{const n=e.target.getAttribute("id"),t=document.querySelector(`nav li a[href="#${n}"]`);t!==null&&(e.intersectionRatio>0?t.parentElement.classList.add("active"):t.parentElement.classList.remove("active"))})}),e=[];for(let t=1;t<=6;t++)e.push(`article h${t}[id]`);document.querySelectorAll(e.join()).forEach(e=>{t.observe(e)})})</script></main><footer class="text-neutral-500 dark:text-neutral-500 bg-neutral-200 dark:bg-neutral-900"><div class="container flex flex-row px-6 lg:px-8 xl:px-12 py-4 mx-auto text-sm max-w-7xl"><div class="flex-1"><p>&copy;
2023</p><p class="text-sm">Powered by <a class="hover:underline hover:text-primary-500" href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:text-primary-500" href="https://canstand.github.io/compost" target="_blank" rel="noopener noreferrer">Compost</a></p></div><div class="flex-1"></div></div></footer></body></html>