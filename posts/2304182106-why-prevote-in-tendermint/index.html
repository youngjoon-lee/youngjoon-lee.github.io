<!doctype html><html dir="ltr" lang="en"><head><meta charset="utf-8"><meta http-equiv="content-language" content="en-us"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Why prevote in Tendermint &#183; Youngjoon Lee</title><meta name="title" content="Why prevote in Tendermint &#183; Youngjoon Lee"><meta name="description" content="Prevote -> Precommnit -> Commit"><link rel="canonical" href="https://oudwud.dev/posts/2304182106-why-prevote-in-tendermint/"><link type="text/css" rel="stylesheet" href="/css/main.min.3db6f820f85fa8b01cb73aa7c8e2c207d0837c77e04635cc5b4dd9a5b2327ac8.css" integrity="sha256-Pbb4IPhfqLActzqnyOLCB9CDfHfgRjXMW03ZpbIyesg="><link rel="icon" sizes="192x192" href="/logo-192.png"><link rel="apple-touch-icon" href="/logo-192.png"><link rel="mask-icon" href="/logo.svg" color="blue"><link rel="manifest" href="/site.webmanifest"><meta property="og:title" content="Why prevote in Tendermint"><meta property="og:description" content="Prevote -> Precommnit -> Commit"><meta property="og:type" content="article"><meta property="og:url" content="https://oudwud.dev/posts/2304182106-why-prevote-in-tendermint/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-04-18T21:06:00+09:00"><meta property="article:modified_time" content="2023-04-18T21:06:00+09:00"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Why prevote in Tendermint"><meta name="twitter:description" content="Prevote -> Precommnit -> Commit"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","articleSection":"Posts","name":"Why prevote in Tendermint","headline":"Why prevote in Tendermint","description":"Prevote -\u003e Precommnit -\u003e Commit","inLanguage":"en-us","author":{"@type":"Person","name":""},"creator":{"@type":"Person","name":""},"copyrightHolder":"","copyrightYear":"2023","dateCreated":"2023-04-18T21:06:00\u002b09:00","datePublished":"2023-04-18T21:06:00\u002b09:00","dateModified":"2023-04-18T21:06:00\u002b09:00","url":"https:\/\/oudwud.dev\/posts\/2304182106-why-prevote-in-tendermint\/","wordCount":"521","keywords":[]}</script><meta name="generator" content="Hugo 0.111.3"><script defer src="/js/main.min.3bfc9774c933123803ba09c8b89eeda9822dd63321db002f0bfd9cdc3129b0fa.js" integrity="sha256-O/yXdMkzEjgDugnIuJ7tqYIt1jMh2wAvC/2c3DEpsPo="></script>
<script>"theme"in localStorage||(localStorage.theme="light"),(localStorage.theme==="dark"||(!("theme"in localStorage)||localStorage.theme==="auto")&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.documentElement.classList.add("dark")</script></head><body class="w-full min-h-full" x-data="{ up: false }"><div x-data="{ open: false }" @keydown.window.escape="open = false" class="sticky inset-x-0 top-0 z-10"><div class="fixed z-10 flex w-48 h-screen lg:hidden" :class="open ? '' : 'hidden'" x-ref="dialog" aria-modal="true"><div class="fixed inset-0 bg-black bg-opacity-25" :class="open ? '' : 'hidden'" x-transition:enter="transition-opacity ease-linear duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="transition-opacity ease-linear duration-300" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" x-description="Off-canvas menu overlay, show/hide based on off-canvas menu state." @click="open = false" aria-hidden="true"></div><div class="fixed inset-0 flex flex-col w-full h-full pb-12 overflow-y-auto shadow-xl bg-neutral-50 text-neutral-900 dark:bg-neutral-800 dark:text-neutral-200 max-w-xxs" :class="open ? '' : 'hidden'" x-transition:enter="transition ease-in-out duration-300" x-transition:enter-start="-translate-x-full" x-transition:enter-end="translate-x-0" x-transition:leave="transition ease-in-out duration-300" x-transition:leave-start="translate-x-0" x-transition:leave-end="-translate-x-full" x-description="Off-canvas menu, show/hide based on off-canvas menu state."><div class="flex px-4 pt-5 pb-2"><button type="button" title="Close menu" class="inline-flex items-center justify-center p-2 -m-2 rounded-md text-neutral-400" @click="open = false">
<span class="sr-only">Close menu</span><svg class="w-6 h-6" x-description="Heroicon name: outline/x" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentcolor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18 18 6M6 6l12 12"/></svg></button></div><ul class="py-4 divide-y divide-neutral-200"><li class="flow-root px-4 py-2"><a href="/" title="Youngjoon Lee" class="block p-2 -m-2 font-medium">Home</a></li><li class="flow-root px-4 py-2
bg-neutral-200 dark:bg-neutral-900"><a href="/posts/" title="Posts" class="block p-2 -m-2 font-medium">Blog</a></li><li class="flow-root px-4 py-2"><a href="/categories/" title="Categories" class="block p-2 -m-2 font-medium">Categories</a></li><li class="flow-root px-4 py-2"><a href="/tags/" title="Tags" class="block p-2 -m-2 font-medium">Tags</a></li></ul></div></div><header class="shadow dark:shadow-dark bg-neutral-50 text-neutral-900 dark:bg-neutral-800 dark:text-neutral-200"><nav class="container flex leading-12 items-center px-6 mx-auto max-w-7xl lg:px-8 xl:px-12 bg-neutral-50 text-neutral-900 dark:bg-neutral-800 dark:text-neutral-200" aria-label="Top"><a class="relative hidden p-2 align-middle lg:block" rel="me" href="/" title="Youngjoon Lee"><img src="/logo-192.png" class="h-8 w-auto" alt="Youngjoon Lee"></a>
<button class="lg:hidden" type="button" @click="open = true" aria-label="Open menu"><svg class="block w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentcolor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg></button><div class="flex-grow h-12 mx-2"><div class="relative w-full h-full"><div class="absolute max-w-full" :class="up ? 'hidden' : ''" x-transition.duration.500ms><span class="font-semibold overflow-hidden text-ellipsis whitespace-nowrap">Youngjoon Lee</span></div><template x-if="true"><div class="absolute top-0 left-0 right-0 max-w-full" :class="up ? '' : 'hidden'" x-transition.duration.500ms><span class="overflow-hidden text-ellipsis whitespace-nowrap">Why prevote in Tendermint</span></div></template></div></div><ul class="shrink hidden ml-7 lg:flex flex-row justify-end list-none"><li class="border-b-2 border-transparent text-right mr-7 hover:border-primary-500"><a href="/" title="Youngjoon Lee">Home</a></li><li class="border-b-2 border-transparent text-right mr-7 hover:border-primary-500
border-primary-500"><a href="/posts/" title="Posts">Blog</a></li><li class="border-b-2 border-transparent text-right mr-7 hover:border-primary-500"><a href="/categories/" title="Categories">Categories</a></li><li class="border-b-2 border-transparent text-right mr-7 hover:border-primary-500"><a href="/tags/" title="Tags">Tags</a></li></ul><button id="switchTheme" class="w-8 h-8 flex justify-center items-center focus:outline-none">
<span class="sr-only">Switch theme</span><svg class="w-5 h-5" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/></svg>
<span class="light"></span><span class="dark"></span></button>
<script>document.getElementById("switchTheme").addEventListener("click",function(){localStorage.theme==="dark"||(!("theme"in localStorage)||localStorage.theme==="auto")&&window.matchMedia("(prefers-color-scheme: dark)").matches?(document.documentElement.classList.remove("dark"),localStorage.theme="light"):(localStorage.theme==="light"||(!("theme"in localStorage)||localStorage.theme==="auto")&&window.matchMedia("(prefers-color-scheme: light)").matches)&&(document.documentElement.classList.add("dark"),localStorage.theme="dark")})</script></nav></header></div><main class="container flex flex-row px-6 mx-auto my-6 lg:px-8 xl:px-12 max-w-7xl"><article class="flex-grow mx-auto text-lg lg:text-xl min-w-0 max-w-prose"><header class="text-base"><h1 class="my-3 text-3xl font-semibold text-neutral-800 dark:text-neutral-200" x-intersect:enter="up = false" x-intersect:leave="up = true">Why prevote in Tendermint</h1><div class="mb-6 text-base text-neutral-500 dark:text-neutral-400"><div class="flex flex-row items-center"><time datetime="2023-04-18 21:06:00 +0900 +0900">18 April 2023</time><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">3 mins</span></div></div></header><section class="max-w-none text-base prose dark:prose-invert"><p>Tendermint Byzantine Fault Tolerance (hereafter BFT) consensus algorithm has two stages of voting before committing a block to the state,
while Raft consensus algorithm (that doesn&rsquo;t cover the Byzantine problem) has a single stage of preparation (aka. log replication) for committing a transaction.
When I first met Tendermint, I was most curious why Tendermint has the two-stage voting (prevote-precommit).</p><p>In <a href="https://atrium.lib.uoguelph.ca/xmlui/handle/10214/9769" target="_blank" rel="noopener">Ethan Buchman 2016</a>, he mentioned as below:</p><blockquote><p>In asynchronous environments with Byzantine validators, a single stage
of voting, where each validator casts only one vote, is not sufficient to ensure
safety. In essence, because validators can act fraudulently, and because there
are no guarantees on message delivery time, a rogue validator can co-ordinate
some validators to commit a value while others, having not seen the commit,
go to a new round, within which they commit a different value.<br>A single stage of voting allows validators to tell each other what they
know about the proposal. But to tolerate Byzantine faults (which amounts,
essentially to lies, fraud, deceit, etc.), they must also tell each other what
they know about what other validators have professed to know about the
proposal. In other words, a second stage ensures that enough validators
witnessed the result of the first stage.</p></blockquote><p>That sounds reasonable, but I wanted to see a specific counterexample that explains why only precommit without prevote is not sufficient.</p><p>Fortunately, I found a counterexample from a <a href="https://www.reddit.com/r/cosmosnetwork/comments/8zwais/comment/e2nyg92/?utm_source=reddit&amp;utm_medium=web2x&amp;context=3" target="_blank" rel="noopener">Reddit post</a>.
Below, I am going to go into details on this counterexample.</p><p>Let&rsquo;s assume that Tendermint has only single stage of voting (aka. precommit), and the network consists of the following validator nodes:</p><ul><li>100 validator nodes in the network<ul><li>28 offline nodes (e.g. due to network partitioning)</li><li>65 honest nodes</li><li>1 honest node (aka. <code>H</code>)</li><li>1 Byzantine node (aka. <code>B</code>)</li></ul></li></ul><p>Let&rsquo;s say the current round is <code>n</code>. A &ldquo;valid&rdquo; block is proposed by one of the validators.
Then, all 66 (= 65 + 1) honest nodes broadcast a precommit for this valid block.
But, let&rsquo;s imagine the case when the Byzantine node <code>B</code> sends <code>nil</code> to 65 honest nodes and itself, but a precommit to the honest node <code>H</code>.</p><p>In this case, <code>H</code> has 67 precommits (<code>> 100 * 2/3</code>) with its own vote. Then, <code>H</code> will commit the block.
However, all other nodes (65 honest + <code>B</code>) move to the next round <code>n+1</code> because they have only 66 precommits (<code>&lt; 100 * 2/3</code>).</p><p>This result is a breach of safety because the honest node <code>H</code> committed the block that all other honest nodes didn&rsquo;t commit.</p><p>If Tendermint has the prevote-precommit mechanism, the above example can be resolved safely.
Let&rsquo;s replace all precommits in the above example with prevotes.
Then, <code>H</code> will broadcast a precommit to all other nodes instead of committing the block to its state,
but it won&rsquo;t receive 2/3+ precommit from other nodes because all other nodes except <code>H</code> won&rsquo;t broadcast a precommit since they didn&rsquo;t receive 2/3+ prevotes.
As a result, all nodes will move to the next round <code>n+1</code> without committing the block.
Then, the consensus remains safe, even if any new block never be committed due to <code>B</code> in subsequent rounds.</p></section><footer class="pt-8"><div class="flex text-base text-neutral-500 dark:text-neutral-400"><div class="place-self-center"></div></div><div class="article-pagination"><hr><div><span><a class="flex text-right" href="/posts/2303281600-whats-happened/"><span class="mr-3 article-pagination-direction">&larr;</span>
<span class="flex flex-col"><span class="article-pagination-title">What's happened, happened</span>
<span class="article-pagination-date"><time datetime="2023-03-28 16:00:00 +0900 +0900">28 March 2023</time></span></span></a></span>
<span><a class="flex" href="/posts/2305021340-astronvim-contribution/"><span class="flex flex-col"><span class="article-pagination-title">OSS Contribution: AstroNvim/astrocommunity</span>
<span class="article-pagination-date"><time datetime="2023-05-02 13:40:00 +0900 +0900">2 May 2023</time></span></span>
<span class="ml-3 article-pagination-direction">&rarr;</span></a></span></div></div></footer></article><aside class="flex-auto min-w-0 space-y-6 pl-10 mt-3 pr-4 xl:pl-16 hidden lg:block text-sm xl:text-base"><div class="sticky self-start top-20 min-h-screen overflow-y-auto truncate"><label class="font-bold text-lg mb-4">Table of contents</label><nav id="TableOfContents"></nav></div></aside><script>window.addEventListener("DOMContentLoaded",()=>{const t=new IntersectionObserver(e=>{e.forEach(e=>{const n=e.target.getAttribute("id"),t=document.querySelector(`nav li a[href="#${n}"]`);t!==null&&(e.intersectionRatio>0?t.parentElement.classList.add("active"):t.parentElement.classList.remove("active"))})}),e=[];for(let t=1;t<=6;t++)e.push(`article h${t}[id]`);document.querySelectorAll(e.join()).forEach(e=>{t.observe(e)})})</script></main><footer class="text-neutral-500 dark:text-neutral-500 bg-neutral-200 dark:bg-neutral-900"><div class="container flex flex-row px-6 lg:px-8 xl:px-12 py-4 mx-auto text-sm max-w-7xl"><div class="flex-1"><p>&copy;
2023</p><p class="text-sm">Powered by <a class="hover:underline hover:text-primary-500" href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:text-primary-500" href="https://canstand.github.io/compost" target="_blank" rel="noopener noreferrer">Compost</a></p></div><div class="flex-1"></div></div></footer></body></html>