<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=/favicon.ico><title>Why prevote in Tendermint - Youngjoon Lee
</title><meta name=description content="Prevote -> Precommit -> Commit"><meta name=generator content="Hugo 0.121.2"><link rel=stylesheet href=https://oudwud.dev/css/main.css><meta property="og:title" content="Why prevote in Tendermint"><meta property="og:description" content="Prevote -> Precommit -> Commit"><meta property="og:type" content="article"><meta property="og:url" content="https://oudwud.dev/articles/2304182106-why-prevote-in-tendermint/"><meta property="og:image" content="https://oudwud.dev/digital-garden-logo.png"><meta property="article:section" content="articles"><meta property="article:published_time" content="2023-04-18T21:06:00+09:00"><meta property="article:modified_time" content="2023-04-18T21:06:00+09:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://oudwud.dev/digital-garden-logo.png"><meta name=twitter:title content="Why prevote in Tendermint"><meta name=twitter:description content="Prevote -> Precommit -> Commit"><meta itemprop=name content="Why prevote in Tendermint"><meta itemprop=description content="Prevote -> Precommit -> Commit"><meta itemprop=datePublished content="2023-04-18T21:06:00+09:00"><meta itemprop=dateModified content="2023-04-18T21:06:00+09:00"><meta itemprop=wordCount content="521"><meta itemprop=image content="https://oudwud.dev/digital-garden-logo.png"><meta itemprop=keywords content><meta itemprop=name content="Why prevote in Tendermint"><meta itemprop=description content="Prevote -> Precommit -> Commit"><meta itemprop=datePublished content="2023-04-18T21:06:00+09:00"><meta itemprop=dateModified content="2023-04-18T21:06:00+09:00"><meta itemprop=wordCount content="521"><meta itemprop=image content="https://oudwud.dev/digital-garden-logo.png"><meta itemprop=keywords content></head><body class="flex relative h-full min-h-screen"><aside class="will-change-transform transform transition-transform -translate-x-full absolute top-0 left-0 md:relative md:translate-x-0 w-3/4 md:basis-60 h-full min-h-screen p-3 bg-slate-50 dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 flex flex-col gap-2.5 z-20 sidebar flex-shrink-0"><p class="font-bold mb-5 flex items-center gap-2"><button aria-label="Close sidebar" class="md:hidden menu-trigger-close p-1 rounded text-slate-800 dark:text-slate-50 hover:bg-slate-200 dark:hover:bg-slate-700"><svg class="h-6 w-6" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
<a href=https://oudwud.dev class=px-2><span>Youngjoon Lee</span>
</a><button aria-label="Toggle dark mode" class="dark-mode-toggle p-2 rounded border dark:border-slate-700 hover:bg-slate-200 dark:hover:bg-slate-700"><svg class="h-4 w-4" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="4"/><path d="M3 12h1m8-9v1m8 8h1m-9 8v1M5.6 5.6l.7.7m12.1-.7-.7.7m0 11.4.7.7M6.3 17.7l-.7.7"/></svg></button></p><ul class="list-none flex flex-col gap-1"><li><a class="px-2 py-1.5 rounded-md text-sm flex items-center justify-between hover:bg-slate-200 dark:hover:bg-slate-700" href=/><span>Home</span></a></li><li><a class="px-2 py-1.5 rounded-md text-sm flex items-center justify-between text-slate-400 font-semibold pb-0 pl-1 border-b cursor-default pointer-events-none" href=#><span>Content</span></a></li><li><a class="px-2 py-1.5 rounded-md text-sm flex items-center justify-between hover:bg-slate-200 dark:hover:bg-slate-700" href=/articles><span>Articles</span></a></li><li><a class="px-2 py-1.5 rounded-md text-sm flex items-center justify-between hover:bg-slate-200 dark:hover:bg-slate-700" href=/portfolio><span>Portfolio</span></a></li><li><a class="px-2 py-1.5 rounded-md text-sm flex items-center justify-between hover:bg-slate-200 dark:hover:bg-slate-700" href=/stack><span>Stack</span></a></li><li><a class="px-2 py-1.5 rounded-md text-sm flex items-center justify-between text-slate-400 font-semibold pb-0 pl-1 border-b cursor-default pointer-events-none" href=#><span>Links</span></a></li><li><a class="px-2 py-1.5 rounded-md text-sm flex items-center justify-between hover:bg-slate-200 dark:hover:bg-slate-700" href=https://polywork.com target=_blank rel=noopener><span>Polywork</span>
<span><svg class="h-4 w-4" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11 7H6A2 2 0 004 9v9a2 2 0 002 2h9a2 2 0 002-2v-5"/><line x1="10" y1="14" x2="20" y2="4"/><polyline points="15 4 20 4 20 9"/></svg></span></a></li></ul><div class=flex-1></div><div class=newsletter-widget><div class="text-bold text-sm">Subscribe to my newsletter</div><p class="text-xs my-1 text-slate-500">A curated weekly digest once a week to your mailbox</p><form action=https://buttondown.email/api/emails/embed-subscribe/ method=post id=newsletter_form target=_blank><div class=mt-2><input type=email class="w-full px-1.5 py-0.5 text-sm rounded border dark:border-slate-700 dark:bg-slate-600" name=email id=member_email placeholder="Your email address...">
<input type=submit class="mt-2 w-full text-center text-sm bg-slate-800 text-white dark:bg-slate-50 dark:text-slate-800 py-1 rounded cursor-pointer" name=subscribe id=member_submit value=Subscribe></div></form></div><ul class="list-none flex flex-wrap justify-center gap-1 pt-2 border-t border-slate-200 dark:border-slate-600"><li><a class="px-2 py-1.5 rounded-md text-sm block text-slate-800 dark:text-slate-50 hover:bg-slate-200 dark:hover:bg-slate-700" href=https://twitter.com/oudwud target=_blank rel="noopener noreferrer"><span class=sr-only>Twitter</span>
<span><svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></span></a></li><li><a class="px-2 py-1.5 rounded-md text-sm block text-slate-800 dark:text-slate-50 hover:bg-slate-200 dark:hover:bg-slate-700" href=https://github.com/youngjoon-lee target=_blank rel="noopener noreferrer"><span class=sr-only>GitHub</span>
<span><svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></span></a></li><li><a class="px-2 py-1.5 rounded-md text-sm block text-slate-800 dark:text-slate-50 hover:bg-slate-200 dark:hover:bg-slate-700" href=https://www.linkedin.com/in/youngjoon-lee-11ba7b72/ target=_blank rel="noopener noreferrer"><span class=sr-only>LinkedIn</span>
<span><svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></span></a></li><li><a class="px-2 py-1.5 rounded-md text-sm block text-slate-800 dark:text-slate-50 hover:bg-slate-200 dark:hover:bg-slate-700" href=mailto:taxihighway@gmail.com target=_blank rel="noopener noreferrer"><span class=sr-only>Email</span>
<span><svg class="h-4 w-4" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="5" width="18" height="14" rx="2"/><polyline points="3 7 12 13 21 7"/></svg></span></a></li><li><a class="px-2 py-1.5 rounded-md text-sm block text-slate-800 dark:text-slate-50 hover:bg-slate-200 dark:hover:bg-slate-700" href=/articles/index.xml target=_blank rel="noopener noreferrer"><span class=sr-only>RSS</span>
<span><svg class="h-4 w-4" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></span></a></li></ul></aside><div class="fixed bg-slate-700 bg-opacity-5 transition duration-200 ease-in-out inset-0 z-10 pointer-events-auto md:hidden left-0 top-0 w-full h-full hidden menu-overlay"></div><button aria-label="Toggle Sidebar" class="md:hidden absolute top-3 left-3 z-10 menu-trigger p-1 rounded text-slate-800 dark:text-slate-50 hover:bg-slate-100"><svg class="h-6 w-6" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="12" x2="20" y2="12"/><line x1="4" y1="18" x2="16" y2="18"/></svg></button><div class="flex flex-1 h-screen relative w-full min-w-0"><section class="will-change-transform transform transition-transform -translate-x-[200%] absolute top-0 left-0 lg:relative
lg:translate-x-0 lg:basis-[400px] h-full bg-slate-50 dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 lg:flex flex-col py-3 overflow-y-auto scroll-area flex-shrink-0"><a href=https://oudwud.dev/articles/><h2 class="font-bold mb-5 py-1 pl-12 pr-3 md:px-3">Articles</h2></a><label class="mb-2 block px-2"><span></span>
<input type=text placeholder="Search articles" class="searchInput bg-white rounded px-2 py-1 w-full border">
</label><script>const searchElt=document.querySelector(".searchInput");searchElt&&searchElt.addEventListener("input",e=>{const n=e.target.value||"",t=document.querySelectorAll(".article");n?(t.forEach(e=>e.classList.add("hidden")),Array.from(t).filter(e=>{const t=e.querySelector("h3");return!!t&&t.textContent.toLowerCase().includes(n.toLowerCase())}).forEach(e=>e.classList.remove("hidden"))):t.forEach(e=>e.classList.remove("hidden"))})</script><div class=space-y-2.5><a class="article block px-3 py-4 hover:bg-slate-200 dark:hover:bg-slate-700" href=/articles/2306261650-hackfs-2023/><h3 class="text-lg font-semibold mb-0.5">A small achievement in HackFS 2023</h3><div class="text-sm text-slate-500 dark:text-slate-400 line-clamp-2">https://ethglobal.com/showcase/libp2p-universal-connectivity-file-sharing-or7cn</div></a><a class="article block px-3 py-4 hover:bg-slate-200 dark:hover:bg-slate-700" href=/articles/2305102345-made-rust-libp2p-gossipsub-work-in-wasm/><h3 class="text-lg font-semibold mb-0.5">Made rust-libp2p gossipsub work in WASM</h3><div class="text-sm text-slate-500 dark:text-slate-400 line-clamp-2">Background In rust-libp2p v0.51.3, the gossipsub module cannot be compiled with the target wasm32-unknown-unknown because the wasm-timer crate required by gossipsub throws the following error, as mentioned in my previous post.
$ wasm-pack build [INFO]: 🎯 Checking for the Wasm target... [INFO]: 🌀 Compiling to Wasm... Compiling libp2p-gossipsub v0.45.0 (https://github.com/libp2p/rust-libp2p.git?branch=master#14938043) error[E0599]: no method named `checked_add` found for struct `wasm_timer::Instant` in the current scope --> /Users/yjlee/.cargo/git/checkouts/rust-libp2p-98135dbcf5b63918/1493804/protocols/gossipsub/src/peer_score.rs:872:34 | 871 | ... let window_time = validated_time | _________________________________________- 872 | | .</div></a><a class="article block px-3 py-4 hover:bg-slate-200 dark:hover:bg-slate-700" href=/articles/2305042345-exploring-rust-libp2p/><h3 class="text-lg font-semibold mb-0.5">Exploring rust-libp2p</h3><div class="text-sm text-slate-500 dark:text-slate-400 line-clamp-2">Connectivity Tests In libp2p.io, the current state of Transport implementations in each programming language is already written. But, I’ve seen there have been so many changes in rust-libp2p, as described in the rust-libp2p in 2022 blog post.
After reading the libp2p Connectivity document, I&rsquo;ve tested if &lsquo;dialing&rsquo; works for each of the following scenarios using rust-libp2p v0.51.3.
Scenario Dialing Transports tested Standalone -> Standalone Successful TCP, WebSocket, WebRTC1 WASM browser -> Standalone Successful WebSocket2 WASM browser &lt;- Standalone Failed3 WebSocket WASM browser -> WASM browser Failed3 WebSocket JS browser4 -> Standalone Successful WebRTC Private -> (Relay5) -> Private Successful TCP Private6 -> (Relay5) -> Private with Hole-punching Failed7 TCP WASM Limitations I&rsquo;ve found that the following features of rust-libp2p cannot be enabled for WASM.</div></a><a class="article block px-3 py-4 hover:bg-slate-200 dark:hover:bg-slate-700" href=/articles/2305021340-astronvim-contribution/><h3 class="text-lg font-semibold mb-0.5">OSS Contribution: AstroNvim/astrocommunity</h3><div class="text-sm text-slate-500 dark:text-slate-400 line-clamp-2">AstroNvim/astrocommunity: feat(git): add openingh #178</div></a><a class="article block px-3 py-4 bg-slate-900 dark:bg-slate-700 text-slate-50" href=/articles/2304182106-why-prevote-in-tendermint/><h3 class="text-lg font-semibold mb-0.5">Why prevote in Tendermint</h3><div class="text-sm text-slate-400 line-clamp-2">Tendermint Byzantine Fault Tolerance (hereafter BFT) consensus algorithm has two stages of voting before committing a block to the state, while Raft consensus algorithm (that doesn&rsquo;t cover the Byzantine problem) has a single stage of preparation (aka. log replication) for committing a transaction. When I first met Tendermint, I was most curious why Tendermint has the two-stage voting (prevote-precommit).
In Ethan Buchman 2016, he mentioned as below:
In asynchronous environments with Byzantine validators, a single stage of voting, where each validator casts only one vote, is not sufficient to ensure safety.</div></a><a class="article block px-3 py-4 hover:bg-slate-200 dark:hover:bg-slate-700" href=/articles/2303281600-whats-happened/><h3 class="text-lg font-semibold mb-0.5">What's happened, happened</h3><div class="text-sm text-slate-500 dark:text-slate-400 line-clamp-2">It&rsquo;s an expression of faith in the mechanics of the world. It&rsquo;s not an excuse for doing nothing.</div></a><a class="article block px-3 py-4 hover:bg-slate-200 dark:hover:bg-slate-700" href=/articles/2103301623-bls-contribution/><h3 class="text-lg font-semibold mb-0.5">OSS Contribution: bls12-381</h3><div class="text-sm text-slate-500 dark:text-slate-400 line-clamp-2">bls12-381: Support 32-bit architecture (#31)</div></a><a class="article block px-3 py-4 hover:bg-slate-200 dark:hover:bg-slate-700" href=/articles/2007061657-thought_about_storage_on_k8s/><h3 class="text-lg font-semibold mb-0.5">Thought about Storage on Kubernetes</h3><div class="text-sm text-slate-500 dark:text-slate-400 line-clamp-2">Kubernetes is revolutionizing the way applications are being developed and deployed. Now, developers can focus on implementing the application itself without worrying about the underlying infrastructure and some of distributed system concepts.
However, Kubernetes doesn&rsquo;t support storing state, even though most of applications are stateful.
On Kubernetes, containers can being created and destroyed. They are dynamic. But, persistent storages cannot be dynamic as normal Pods.
Many SW teams have been using distributed storage solutions provided by cloud providers, such as AWS or GCP.</div></a><a class="article block px-3 py-4 hover:bg-slate-200 dark:hover:bg-slate-700" href=/articles/2006281453-hyperloglog/><h3 class="text-lg font-semibold mb-0.5">HyperLogLog</h3><div class="text-sm text-slate-500 dark:text-slate-400 line-clamp-2">Given a stream of strings, let&rsquo;s think how to count the number of distinct strings (Cardinality).
Using in-memory data structure The simplest way might be using a in-memory data structure, such as HashSet. Whenever we read a string from the stream, we can add it to the HashSet. Finally, we can return the final size of HashSet.
But, this way needs O(n) of memory at most, if n is the number of strings in the stream.</div></a><a class="article block px-3 py-4 hover:bg-slate-200 dark:hover:bg-slate-700" href=/articles/2006111140-argo-release/><h3 class="text-lg font-semibold mb-0.5">My first open source contribution was just released.</h3><div class="text-sm text-slate-500 dark:text-slate-400 line-clamp-2">My first open source contribution (bugfix) to Argo. It was just released as v2.9.0-rc1.</div></a></div></section><div class="overflow-y-auto h-screen w-full"><article class="px-6 py-20 w-full mx-auto prose lg:prose-lg h-fit dark:prose-invert prose-img:mx-auto"><h1 class=!mb-2>Why prevote in Tendermint</h1><p class="text-sm text-slate-500 !mb-8">Planted April 18, 2023</p><p>Tendermint Byzantine Fault Tolerance (hereafter BFT) consensus algorithm has two stages of voting before committing a block to the state,
while Raft consensus algorithm (that doesn&rsquo;t cover the Byzantine problem) has a single stage of preparation (aka. log replication) for committing a transaction.
When I first met Tendermint, I was most curious why Tendermint has the two-stage voting (prevote-precommit).</p><p>In <a href=https://atrium.lib.uoguelph.ca/xmlui/handle/10214/9769 target=_blank rel=noopener>Ethan Buchman 2016</a>, he mentioned as below:</p><blockquote><p>In asynchronous environments with Byzantine validators, a single stage
of voting, where each validator casts only one vote, is not sufficient to ensure
safety. In essence, because validators can act fraudulently, and because there
are no guarantees on message delivery time, a rogue validator can co-ordinate
some validators to commit a value while others, having not seen the commit,
go to a new round, within which they commit a different value.<br>A single stage of voting allows validators to tell each other what they
know about the proposal. But to tolerate Byzantine faults (which amounts,
essentially to lies, fraud, deceit, etc.), they must also tell each other what
they know about what other validators have professed to know about the
proposal. In other words, a second stage ensures that enough validators
witnessed the result of the first stage.</p></blockquote><p>That sounds reasonable, but I wanted to see a specific counterexample that explains why only precommit without prevote is not sufficient.</p><p>Fortunately, I found a counterexample from a <a href="https://www.reddit.com/r/cosmosnetwork/comments/8zwais/comment/e2nyg92/?utm_source=reddit&amp;utm_medium=web2x&amp;context=3" target=_blank rel=noopener>Reddit post</a>.
Below, I am going to go into details on this counterexample.</p><p>Let&rsquo;s assume that Tendermint has only single stage of voting (aka. precommit), and the network consists of the following validator nodes:</p><ul><li>100 validator nodes in the network<ul><li>28 offline nodes (e.g. due to network partitioning)</li><li>65 honest nodes</li><li>1 honest node (aka. <code>H</code>)</li><li>1 Byzantine node (aka. <code>B</code>)</li></ul></li></ul><p>Let&rsquo;s say the current round is <code>n</code>. A &ldquo;valid&rdquo; block is proposed by one of the validators.
Then, all 66 (= 65 + 1) honest nodes broadcast a precommit for this valid block.
But, let&rsquo;s imagine the case when the Byzantine node <code>B</code> sends <code>nil</code> to 65 honest nodes and itself, but a precommit to the honest node <code>H</code>.</p><p>In this case, <code>H</code> has 67 precommits (<code>> 100 * 2/3</code>) with its own vote. Then, <code>H</code> will commit the block.
However, all other nodes (65 honest + <code>B</code>) move to the next round <code>n+1</code> because they have only 66 precommits (<code>&lt; 100 * 2/3</code>).</p><p>This result is a breach of safety because the honest node <code>H</code> committed the block that all other honest nodes didn&rsquo;t commit.</p><p>If Tendermint has the prevote-precommit mechanism, the above example can be resolved safely.
Let&rsquo;s replace all precommits in the above example with prevotes.
Then, <code>H</code> will broadcast a precommit to all other nodes instead of committing the block to its state,
but it won&rsquo;t receive 2/3+ precommit from other nodes because all other nodes except <code>H</code> won&rsquo;t broadcast a precommit since they didn&rsquo;t receive 2/3+ prevotes.
As a result, all nodes will move to the next round <code>n+1</code> without committing the block.
Then, the consensus remains safe, even if any new block never be committed due to <code>B</code> in subsequent rounds.</p></article></div></div><script type=text/javascript src=/main.js defer></script><script>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-144368893-2","auto"),ga("send","pageview"))</script></body></html>